= Using in GitLab CI
:description: Guide to using regis-cli in GitLab CI/CD pipelines.

This guide explains how to integrate `regis-cli` into your GitLab CI/CD pipelines to automate container image analysis and security scoring.

== Prerequisites

* A GitLab project.
* GitLab Runner with Docker executor.
* (Optional) `glab` CLI installed locally.

== Bootstrapping a New Project

You can use `cookiecutter` to quickly create a new GitLab repository pre-configured for `regis-cli`.

[source,bash]
----
# Generate the project from the unified template (choose 'gitlab')
pipenv run cookiecutter cookiecutter/

# Create the repository on GitLab and push
cd <your-project-slug>
glab repo create --public
----

== GitLab CI Configuration

The generated `.gitlab-ci.yml` uses GitLab CI `spec: inputs` to parameterize the image analysis.

[source,yaml]
----
include::example$gitlab-ci-fragment.yml[]
----

[NOTE]
====
In GitLab CI, the workspace is automatically available. The template uses a `before_script` to symlink workspace directories to the `/app/playbooks` and `/app/reports` paths expected by the `regis-cli` container.
====

== Running Analysis

Once pushed, you can trigger an analysis manually from the GitLab UI:

1. Go to **Build > Pipelines**.
2. Click **Run pipeline**.
3. Enter the `image_url` input.
4. Click **Run pipeline**.

== Publishing to GitLab Pages

`regis-cli` reports are perfectly suited for GitLab Pages. In GitLab CI, any files placed in a directory named `public` at the end of a job named `pages` will be automatically published.

=== Deployment Job

Add the following job to your `.gitlab-ci.yml`:

[source,yaml]
----
pages:
  stage: deploy
  script:
    - mkdir -p public
    - cp -r reports/* public/
  artifacts:
    paths:
      - public
  only:
    - main
----

The analysis results will be accessible at `https://<your-namespace>.gitlab.io/<your-project-slug>/`.

== Report Versioning

To keep a history of your analysis reports directly in the Git repository, you need to configure a **Project Access Token**:

1. Go to **Settings > Access Tokens**.
2. Create a new token with:
   * **Name**: `GITLAB_TOKEN`
   * **Scopes**: `write_repository`
3. Copy the token.
4. Go to **Settings > CI/CD > Variables**.
5. Add a variable named `GITLAB_TOKEN`, paste the token value, and ensure it is **masked**.

When this variable is present, the CI pipeline will automatically commit and push new reports to your branch.

== Adding CI Metadata

You can enrich your reports with GitLab CI metadata using the `--meta` flag. The default playbook uses the following well-known keys:

* `trigger.user`: The user who initiated the analysis (e.g., `$GITLAB_USER_LOGIN`).
* `trigger.url`: A link to the CI job (e.g., `$CI_JOB_URL`).

[source,bash]
----
regis-cli analyze <image-url> \
  --meta "trigger.user=$GITLAB_USER_LOGIN" \
  --meta "trigger.url=$CI_JOB_URL"
----

== Self-Service Analysis Workflow

This workflow allows authorized users to request a one-off image analysis directly from the GitLab UI.

=== Prerequisites

To enable this workflow, you must configure a **Project Access Token** (or Personal Access Token) as a GitLab CI/CD variable:

*   **Variable Name**: `GITLAB_TOKEN`
*   **Scopes**: `api`, `write_repository`
*   **Role**: `Developer` (minimum)
*   **Protection**: Ensure the variable is **not protected** (or protect the `regis/analyze/*` branch pattern), as it needs to be accessible by pipelines running on dynamically created analysis branches.

=== Request-to-MR Flow
The unified GitLab template supports a full "Self-Service" workflow where any user can request an image analysis via a pipeline input. This creates a focused Merge Request with a dedicated report deployed to a Review App.

[mermaid]
....
sequenceDiagram
    actor User as User/Developer
    participant GL as GitLab UI
    participant CI as CI Runner
    participant Reg as Registry

    User->>GL: Run Pipeline with image_url
    GL->>CI: Job: request_analysis
    Note over CI: Create branch & commit image_url
    CI->>GL: Push with MR options
    GL->>User: Merge Request opened
    GL->>CI: Job: analyze_image (MR context)
    CI->>Reg: Analyze image
    CI->>GL: Commit Report to reports/
    CI->>GL: Post MR Comment with Report Link (via API)
....

=== 1. Trigger the Request
Go to **Build > Pipelines > Run pipeline**, enter the `image_url`, and run.

=== 2. Merge Request Creation
The pipeline automatically creates a new branch and a Merge Request.
The MR description contains instructions to find the **Analysis Report** within the committed \`reports/\` directory or the exposed artifacts.

=== 3. Report Inspection
Once the analysis job completes, the report is:
*   **Committed** back to the branch in the \`reports/<registry>/<repository>/<tag>/\` directory (if `GITLAB_TOKEN` is configured). You can directly review the HTML and JSON results.
*   **Linked in a Comment**: The pipeline will automatically post a comment on the Merge Request containing a direct link to view the HTML report directly in your browser.

=== 4. Governance
Security teams can review the MR, check the compliance score via the direct HTML report link, and decide whether to merge the analysis request into the main registry branch.

== Automated Labeling and Governance

The `regis-cli` integration automatically applies **scoped labels** to the Merge Request based on the analysis results and your playbook configuration.

=== Scoped Labels Configuration

In your `playbook.yaml`, you can define label rules under the `integrations.gitlab.labels` section:

[source,yaml]
----
integrations:
  gitlab:
    labels:
      - name: regis::pass
        condition: {">=": [{var: score}, 90]}
      - name: security::critical
        condition: {">": [{var: results.trivy.critical_count}, 0]}
----

GitLab scoped labels (using the `::` separator) ensure that only one label of a given scope (e.g., `regis::*`) is applied at a time.

=== Integration with Approval Rules

These labels can be used to drive **GitLab Approval Rules** (Premium/Ultimate). You can configure your project settings to require specific approvals when certain labels are present.

*   **Example**: Require `@security-team` approval if the `security::critical` label is applied.
*   **Workflow**:
    1.  User requests analysis.
    2.  `regis-cli` finds a critical vulnerability.
    3.  Pipeline applies `security::critical` label via the GitLab API.
    4.  GitLab Approval Rule detects the label and blocks the Merge Request until a security officer approves it.

== Review Apps (Premium/Ultimate Only)

If you are using a **GitLab Premium** or **Ultimate** tier, you can take advantage of parallel GitLab Pages deployments to host a live "Review App" for every Merge Request instead of relying on raw artifacts.

To enable this, update your `.gitlab-ci.yml`:

[source,yaml]
----
pages:
  stage: deploy
  script:
    - echo "Publishing report..."
  artifacts:
    paths:
      - reports/
  pages:
    path_prefix: "$PAGES_PREFIX"
  rules:
    - if: $CI_MERGE_REQUEST_IID
      variables:
        PAGES_PREFIX: "review-$CI_MERGE_REQUEST_IID"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      variables:
        PAGES_PREFIX: ""
----

This configuration generates a unique URL for each Merge Request (e.g., `\https://<namespace>.gitlab.io/<project>/review-123/`).

