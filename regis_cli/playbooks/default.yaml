# yaml-language-server: $schema=../schemas/playbook.schema.json
name: RegiS Default Playbook

pages:
  - title: Overview
    slug: index
    sections:
      - name: Request Status
        widgets:
          - label: Created on
            value: "{{ request.timestamp | format_datetime }}"
          - label: By
            value: "{{ request.metadata.user | default('Unknown') }}"
          - label: Recommandation
            value: "{{ 'GO' }}"
            options:
              class: recommandation-go
            condition:
              "==": [{ var: playbooks.0.pages.1.sections.1.score }, 100]
          - label: Recommandation
            value: "{{ 'NOGO' }}"
            url: compliance.html
            options:
              class: recommandation-nogo
            condition:
              "<=": [{ var: playbooks.0.pages.1.sections.1.score }, 80]

      - name: Requested Image
        widgets:
          - label: Registry
            value: "{{ request.registry }}"
          - label: Repository
            value: "{{ request.repository }}"
          - label: Tag
            value: "{{ request.tag }}"
      - name: Compliance
        widgets:
          - label: Overall Compliance
            value: "{{ playbooks.0.score }}%"
            url: compliance.html
          - label: Mandatory Requirements
            value: "{{ playbooks.0.pages.1.sections.1.passed_scorecards }} / {{ playbooks.0.pages.1.sections.1.total_scorecards }}"
            url: compliance.html
          - label: Recommended Requirements
            value: "{{ playbooks.0.pages.1.sections.2.passed_scorecards }} / {{ playbooks.0.pages.1.sections.2.total_scorecards }}"
            url: compliance.html
      - name: Context
        widgets:
          - template: request/table.html
            options:
              title: Request Parameters
          - template: metadata/table.html
            options:
              title: Additional Metadata
            condition:
              "!!": [{ var: request.metadata }]

  - title: Compliance
    slug: compliance
    sections:
      - name: " "
        widgets:
          - label: Overall Compliance
            value: "{{ playbooks.0.score }}%"
            options:
              align: center
          - label: Mandatory Requirements
            value: "{{ playbooks.0.pages.1.sections.1.score }}%"
            options:
              align: center
          - label: Recommended Requirements
            value: "{{ playbooks.0.pages.1.sections.2.score }}%"
            options:
              align: center
      - name: Mandatory Requirements
        scorecards:
          - name: no-root
            title: Image must not run as root.
            level: critical
            tags: [security]
            condition:
              "!=": [{ var: results.skopeo.platforms.0.user }, root]
          - name: no-critical
            title: No CRITICAL vulnerabilities found by Trivy.
            level: critical
            tags: [security]
            condition:
              "==": [{ var: results.trivy.critical_count }, 0]
          - name: trusted-domain
            title: Image must originate from a trusted domain.
            tags: [security]
            condition:
              "in":
                [
                  { var: request.registry },
                  [docker.io, registry-1.docker.io, quay.io, ghcr.io],
                ]

      - name: Recommended Requirements
        scorecards:
          - name: no-high
            title: No HIGH vulnerabilities found by Trivy.
            level: warning
            tags: [security]
            condition:
              "==": [{ var: results.trivy.high_count }, 0]
          - name: age
            title: Image should be less than 30 days old.
            level: warning
            tags: [freshness]
            condition:
              "<": [{ var: results.freshness.age_days }, 30]

  - title: Security
    slug: security
    sections:
      - name: Vulnerabilities
        widgets:
          - template: analyzers/trivy/cards.html
          - template: analyzers/trivy/table.html
            options:
              title: Top HIGH and CRITICAL vulnerabilities
              collapsed: true
              limit: 25
      - name: Provenance
        widgets:
          - template: analyzers/provenance/cards.html
          - template: analyzers/provenance/table.html
            options:
              title: Provenance Details
              collapsed: true

  - title: Supply Chain & Quality
    slug: supply-chain
    sections:
      - name: Software Bill of Materials (SBOM)
        widgets:
          - template: analyzers/sbom/cards.html
          - template: analyzers/sbom/table.html
            options:
              title: Component Inventory Preview
              collapsed: true
              limit: 50

      - name: OpenSSF Scorecard
        widgets:
          - template: analyzers/scorecarddev/cards.html
          - template: analyzers/scorecarddev/table.html
            options:
              title: Detailed Check Results
              collapsed: true

  - title: Best Practices
    slug: best-practices
    sections:
      - name: Dockerfile Linting
        widgets:
          - template: analyzers/hadolint/cards.html
          - template: analyzers/hadolint/table.html
            options:
              title: Linting Issues & Recommendations
              collapsed: true

  - title: Insights & Lifecycle
    slug: insights
    sections:
      - name: Image Freshness
        widgets:
          - template: analyzers/freshness/cards.html
          - template: analyzers/freshness/table.html
            options:
              title: Release Details
              collapsed: true

      - name: Popularity & Community
        widgets:
          - template: analyzers/popularity/cards.html
          - template: analyzers/popularity/table.html
            options:
              title: Registry Stats
              collapsed: true

      - name: Lifecycle (EndOfLife)
        widgets:
          - template: analyzers/endoflife/cards.html
          - template: analyzers/endoflife/table.html
            options:
              title: Version Support Status
              collapsed: true

  - title: Technical Details
    slug: metadata
    sections:
      - name: Size & Layers
        widgets:
          - template: analyzers/size/cards.html
          - template: analyzers/size/table.html
            options:
              title: Layer Distribution
              collapsed: true

      - name: Registry Metadata
        widgets:
          - template: analyzers/skopeo/cards.html
          - template: analyzers/skopeo/table.html
            options:
              title: Inspect Details
              collapsed: true

      - name: Versioning Analysis
        widgets:
          - template: analyzers/versioning/cards.html
          - template: analyzers/versioning/table.html
            options:
              title: Tag Logic & Patterns
              collapsed: true
