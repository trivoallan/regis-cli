{% import theme ~ "/macros.html" as m with context %}

{% set icons = {"bronze": "ğŸ¥‰", "silver": "ğŸ¥ˆ", "gold": "ğŸ¥‡", "none": "â­•"} %}

<article>

    {% for page in sc.pages %}
        {% if sc.pages|length > 1 %}
            <h3 style="margin-top: 1rem; color: var(--secondary);">{{ page.name|e }}</h3>
        {% endif %}

        {% for section in page.sections %}
            <div class="scorecard-section">
                <h4>{{ section.name|e }}</h4>

            {% for block in section.render_order %}

                {# â”€â”€ Widgets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
                {% if block == "widgets" and section.display is defined and section.display.widgets is defined %}
                <div class="grid">
                    {% for w in section.display.widgets %}
                        <div>
                            {% if w.icon %}<span style="font-size: 1.5rem;">{{ w.icon }}</span> {% endif %}
                            <strong>{{ w.label|e }}</strong><br>
                            <span style="font-size: 1.4rem; font-weight: bold;">
                                {%- if w.resolved_value is sameas true -%}âœ…
                                {%- elif w.resolved_value is sameas false -%}âŒ
                                {%- elif w.resolved_value is none -%}<span style="opacity: 0.5;">N/A</span>
                                {%- else -%}{{ w.resolved_value }}
                                {%- endif -%}
                            </span>
                        </div>
                    {% endfor %}
                </div>
                <hr>
                {% endif %}

                {# â”€â”€ Levels summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
                {% if block == "levels" and section.levels_summary %}
                <div class="grid">
                    {% for level_name, stats in section.levels_summary.items() %}
                        {% set level_icon = icons.get(level_name, '') %}
                        <div>
                            <strong>{{ level_icon }} {{ level_name|capitalize }}</strong><br>
                            {{ stats.passed }}/{{ stats.total }} passed ({{ stats.percentage }}%)
                        </div>
                    {% endfor %}
                </div>
                <hr>
                {% endif %}

                {# â”€â”€ Tags summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
                {% if block == "tags" and section.tags_summary %}
                <div class="grid">
                    {% for tag_name, stats in section.tags_summary.items() %}
                        <div>
                            <strong>ğŸ·ï¸ {{ tag_name|capitalize }}</strong><br>
                            {{ stats.passed }}/{{ stats.total }} passed ({{ stats.percentage }}%)
                        </div>
                    {% endfor %}
                </div>
                <hr>
                {% endif %}

                {# â”€â”€ Rules table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
                {% if block == "rules" and section.rules %}
                <div class="overflow-auto">
                    <table class="striped">
                        <thead>
                            <tr>
                                <th>Status</th>
                                {% if section.levels_summary %}<th>Level</th>{% endif %}
                                <th>Rule</th>
                                <th>Analyzers</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in section.rules %}
                            <tr>
                                <td>{{ m.bool_icon(r.passed) }}</td>
                                {% if section.levels_summary %}<td><small>{{ r.level|capitalize }}</small></td>{% endif %}
                                <td>
                                    <strong>{{ r.title|e }}</strong>
                                    {% if r.tags %}
                                    <div style="margin-top: 0.2rem;">
                                        {% for tag in r.tags %}
                                        {{ m.badge(tag) }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    <div style="font-size: 0.8rem; opacity: 0.7; margin-top: 0.3rem;">{{ r.details|e }}</div>
                                </td>
                                <td>
                                    {% for analyzer in r.analyzers %}
                                    <small>{{ m.badge(analyzer, status="outline") }}</small>
                                    {% endfor %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}

                {# â”€â”€ Analyzers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
                {% if block == "analyzers" and section.display is defined and section.display.analyzers is defined %}
                    {% for analyzer_name in section.display.analyzers %}
                        {% if analyzer_name in report.results %}
                            {% set name = analyzer_name %}
                            {% set data = report.results[analyzer_name] %}
                            <div id="analyzer-{{ name }}">
                                {% if data.error %}
                                    {{ m.error_card(name, data.error) }}
                                {% else %}
                                    {% include [theme ~ "/analyzers/" ~ name ~ ".html", theme ~ "/analyzers/default.html"] %}
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endfor %}
                {% endif %}

            {% endfor %}
        </div>
        {% if not loop.last %}<hr>{% endif %}

        {% endfor %}

        {% if not loop.last %}<hr style="border-width: 2px;">{% endif %}
    {% endfor %}
</article>
