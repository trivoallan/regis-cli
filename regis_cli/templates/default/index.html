{% extends theme ~ "/base.html" %}
{% import theme ~ "/macros.html" as m with context %}

{% block body %}
    {# Track which analyzers are claimed by scorecards #}
    {% set ns = namespace(claimed_analyzers=[]) %}

    {% for pb in report.playbooks|default([]) %}
        <section id="playbook-{{ loop.index0 }}">
            {% include theme ~ "/playbooks/default.html" with context %}
        </section>

        {# Track claimed analyzers from all sections across all pages #}
        {% for page in pb.pages %}
            {% for section in page.sections %}
                {% if section.display is defined and section.display.analyzers is defined %}
                    {% for analyzer_name in section.display.analyzers %}
                        {% if analyzer_name not in ns.claimed_analyzers %}
                            {% set ns.claimed_analyzers = ns.claimed_analyzers + [analyzer_name] %}
                        {% endif %}
                    {% endfor %}
                {% endif %}
            {% endfor %}
        {% endfor %}
    {% endfor %}

    {# Always show error cards for analyzers not already displayed #}
    {% for name, data in report.results.items()|sort %}
        {% if data.error and name not in ns.claimed_analyzers %}
            {{ m.error_card(name, data.error) }}
        {% endif %}
    {% endfor %}
{% endblock %}
