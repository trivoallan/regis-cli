{% import theme ~ "/macros.html" as m with context %}

{% set total_vuln_count = data.vulnerability_count | default(0) %}

<article>
    <header>
        <h3 style="margin: 0;">üõ°Ô∏è Trivy ({{ total_vuln_count }})</h3>

    </header>

    {% set has_displayed_any = false %}

    {% for target in data.targets %}
        {% if target.Vulnerabilities %}
            {% set sorted_vulns = target.Vulnerabilities|selectattr("Severity", "in", ["CRITICAL", "HIGH"])|list|sort(attribute="Severity") %}

            {% if sorted_vulns %}
                {% set has_displayed_any = true %}
                <div style="margin-top: 1rem;">
                    <h5 style="margin-bottom: 0.5rem; color: var(--secondary);">{{ target.Target|e }}</h5>
                    <div class="overflow-auto">
                        <table class="striped">
                            <thead>
                                <tr>
                                    <th>Severity</th>
                                    <th>ID</th>
                                    <th>Package</th>
                                    <th>Fixed In</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for v in sorted_vulns[:15] %}
                                <tr>
                                    <td>
                                        {% set status = "error" if v.Severity in ["CRITICAL"] else None %}
                                        {{ m.badge(v.Severity, status=status) }}
                                    </td>
                                    <td><code>{{ v.VulnerabilityID|e }}</code></td>
                                    <td>
                                        <strong>{{ v.PkgName|e }}</strong><br>
                                        <small>{{ v.InstalledVersion|e }}</small>
                                    </td>
                                    <td>{{ v.FixedVersion|default("-")|e }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% if sorted_vulns|length > 15 %}
                        <p><small>‚Ä¶ showing top 15 of {{ sorted_vulns|length }} CRITICAL/HIGH vulnerabilities in {{ target.Target|e }}</small></p>
                    {% endif %}
                </div>
            {% endif %}
        {% endif %}
    {% endfor %}
</article>
