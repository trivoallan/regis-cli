{% import theme ~ "/macros.html" as m with context %}

{% set trivy_data = report.results.get('trivy', {}) %}
{% set options = w.options | default({}) %}
{% set limit = options.get('limit', 15) %}
{% set query = options.get('query', {}) %}
{% set severity_filter = query.get('severity', ["CRITICAL", "HIGH"]) %}

{% set ns = namespace(has_displayed_any=false) %}

{% if trivy_data.targets %}
    {% for target in trivy_data.targets %}
        {% if target.Vulnerabilities %}
            {% set sorted_vulns = target.Vulnerabilities | selectattr("Severity", "in", severity_filter) | list | sort(attribute="Severity") %}

            {% if sorted_vulns %}
                {% set ns.has_displayed_any = true %}
                {% set collapsed = options.get('collapsed', false) %}
                <div style="margin-top: 1rem; margin-bottom: 1rem;">
                    <h5 style="margin-bottom: 0.5rem; color: var(--pico-secondary);">{{ target.Target|e }}</h5>
                    <div class="overflow-auto">
                        <table class="striped">
                            <thead>
                                <tr>
                                    <th>Severity</th>
                                    <th>ID</th>
                                    <th>Package</th>
                                    <th>Fixed In</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for v in sorted_vulns[:limit] %}
                                <tr>
                                    <td>
                                        {% set status = "error" if v.Severity in ["CRITICAL"] else None %}
                                        {{ m.badge(v.Severity, status=status) }}
                                    </td>
                                    <td><code>{{ v.VulnerabilityID|e }}</code></td>
                                    <td>
                                        <strong>{{ v.PkgName|e }}</strong><br>
                                        <small>{{ v.InstalledVersion|e }}</small>
                                    </td>
                                    <td>{{ v.FixedVersion|default("-")|e }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% if sorted_vulns|length > limit %}
                        <p style="margin-top: 0.5rem;"><small>â€¦ showing top {{ limit }} of {{ sorted_vulns|length }} vulnerabilities in {{ target.Target|e }}</small></p>
                    {% endif %}
                </div>
            {% endif %}
        {% endif %}
    {% endfor %}
    {% if not ns.has_displayed_any %}
        <p><em>No vulnerabilities matched the criteria.</em></p>
    {% endif %}
{% else %}
    <p><em>No Trivy results available.</em></p>
{% endif %}
