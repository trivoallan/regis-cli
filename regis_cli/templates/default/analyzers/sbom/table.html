{% import theme ~ "/macros.html" as m with context %}
{% set data = report.results.get('sbom', {}) %}
{% set options = w.options | default({}) %}
{% set limit = options.get('limit', 20) %}

{% if data %}
    {# Component types breakdown #}
    {% if data.component_types %}
    <details style="margin-bottom: 1rem;">
        <summary>Component types Distribution</summary>
        <table class="striped">
            <thead>
                <tr><th>Type</th><th>Count</th></tr>
            </thead>
            <tbody>
                {% for ctype, count in data.component_types|dictsort %}
                <tr><td>{{ ctype|e }}</td><td>{{ count }}</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </details>
    {% endif %}

    {# License inventory #}
    {% if data.licenses %}
    <details style="margin-bottom: 1rem;">
        <summary>License Inventory ({{ data.licenses|length }})</summary>
        <div style="display: flex; flex-wrap: wrap; gap: 0.25rem; padding: 0.5rem 0;">
            {% for lic in data.licenses %}
                {{ m.badge(lic) }}
            {% endfor %}
        </div>
    </details>
    {% endif %}

    {# Top components table #}
    {% if data.components %}
    <div class="overflow-auto">
        <table class="striped">
            <thead>
                <tr>
                    <th>Package Name</th>
                    <th>Version</th>
                    <th>Type</th>
                    <th>License</th>
                </tr>
            </thead>
            <tbody>
                {% for c in data.components[:limit] %}
                <tr>
                    <td><code>{{ c.name|e }}</code></td>
                    <td>{{ c.version|default("-")|e }}</td>
                    <td><small>{{ c.type|e }}</small></td>
                    <td>{{ c.licenses|join(", ")|default("-")|e }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% if data.components|length > limit %}
        <p><small>â€¦ showing top {{ limit }} of {{ data.components|length }} components.</small></p>
    {% endif %}
    {% endif %}
{% endif %}
