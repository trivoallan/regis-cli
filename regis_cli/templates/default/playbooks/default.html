{% import theme ~ "/macros.html" as m with context %}

{% set icons = {"bronze": "ğŸ¥‰", "silver": "ğŸ¥ˆ", "gold": "ğŸ¥‡", "none": "â­•"} %}

<article>


    {% for page in pb.pages %}
        {% if pb.pages|length > 1 %}
            <h3 style="margin-top: 1rem; color: var(--secondary);">{{ page.title|e }}</h3>
        {% endif %}

        {% for section in page.sections %}
            <div class="playbook-section">
                <h4>{{ section.name|e }}</h4>
                {% if section.hint %}
                <p class="section-hint">{{ section.hint|e }}</p>
                {% endif %}

            {% for block in section.render_order %}

                {# â”€â”€ Widgets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
                <!-- prettier-ignore-start -->
                {% if block == "widgets" and section.widgets is defined %}
                <div style="margin-bottom: calc(2 * var(--pico-spacing));">
                    {% set ns = namespace(in_grid=false) %}
                    {% for w in section.widgets %}
                        {% set w_opts = w.options or {} %}
                        {% set w_title = w_opts.get('title') %}
                        {% set w_collapsed = w_opts.get('collapsed', false) %}

                        {% if w.template is defined %}
                            {% if ns.in_grid %}
                                </div>
                                {% set ns.in_grid = false %}
                            {% endif %}
                            <div class="widget-template" style="margin-bottom: calc(3 * var(--pico-spacing));">
                                {% if w_collapsed %}
                                <details>
                                    <summary style="font-weight: bold; color: var(--pico-secondary); margin-bottom: 0.5rem; font-size: 1.125rem;">{{ w_title|default(w.label)|e }}</summary>
                                {% elif w_title %}
                                    <h5 style="margin-bottom: 0.5rem; color: var(--pico-secondary);">{{ w_title|e }}</h5>
                                {% endif %}

                                {% include [theme ~ "/" ~ w.template, w.template] %}

                                {% if w_collapsed %}
                                </details>
                                {% endif %}
                            </div>
                        {% else %}
                            {% if w_collapsed or w_title %}
                                {% if ns.in_grid %}
                                    </div>
                                    {% set ns.in_grid = false %}
                                {% endif %}
                                <div style="margin-bottom: calc(4 * var(--pico-spacing));">
                                    {% if w_collapsed %}
                                    <details>
                                        <summary style="font-weight: bold; color: var(--pico-secondary); font-size: 1.125rem;">{{ w_title|default(w.label)|e }}</summary>
                                    {% elif w_title %}
                                        <h6 style="margin-bottom: 0.5rem; color: var(--pico-secondary);">{{ w_title|e }}</h6>
                                    {% endif %}
                                    <div style="padding: var(--pico-spacing); background: var(--pico-card-background-color); border-radius: var(--pico-border-radius); box-shadow: var(--pico-card-box-shadow); {% if w.resolved_url %}cursor: pointer;{% endif %}">
                                        {%- if w.resolved_url -%}<a href="{{ w.resolved_url }}" style="text-decoration: none; color: inherit; display: block;">{%- endif -%}
                                        {% if w.icon %}<span style="font-size: 1.5rem;">{{ w.icon }}</span> {% endif %}
                                        <strong>{{ w.label|e }}</strong><br>
                                        <span style="font-size: 1.4rem; font-weight: bold;">
                                            {%- if w.resolved_value is sameas true -%}âœ…
                                            {%- elif w.resolved_value is sameas false -%}âŒ
                                            {%- elif w.resolved_value is none -%}<span style="opacity: 0.5;">N/A</span>
                                            {%- else -%}{{ w.resolved_value }}
                                            {%- endif -%}
                                        </span>
                                        {%- if w.resolved_url -%}</a>{%- endif -%}
                                    </div>
                                    {% if w_collapsed %}
                                    </details>
                                    {% endif %}
                                </div>
                            {% else %}
                                {% if not ns.in_grid %}
                                    <div class="grid" style="margin-bottom: calc(4 * var(--pico-spacing));">
                                    {% set ns.in_grid = true %}
                                {% endif %}
                                <div>
                                    {%- if w.resolved_url -%}<a href="{{ w.resolved_url }}" style="text-decoration: none; color: inherit; display: block;">{%- endif -%}
                                    {% if w.icon %}<span style="font-size: 1.5rem;">{{ w.icon }}</span> {% endif %}
                                    <strong>{{ w.label|e }}</strong><br>
                                    <span style="font-size: 1.4rem; font-weight: bold;">
                                        {%- if w.resolved_value is sameas true -%}âœ…
                                        {%- elif w.resolved_value is sameas false -%}âŒ
                                        {%- elif w.resolved_value is none -%}<span style="opacity: 0.5;">N/A</span>
                                        {%- else -%}{{ w.resolved_value }}
                                        {%- endif -%}
                                    </span>
                                    {%- if w.resolved_url -%}</a>{%- endif -%}
                                </div>
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                    {% if ns.in_grid %}
                        </div>
                    {% endif %}
                </div>
                <!-- prettier-ignore-end -->
                <hr>
                {% endif %}

                {# â”€â”€ Levels summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
                {% if block == "levels" and section.levels_summary %}
                <div class="grid" style="margin-bottom: calc(3 * var(--pico-spacing));">
                    {% for level_name, stats in section.levels_summary.items() %}
                        {% set level_icon = icons.get(level_name, '') %}
                        <div style="text-align: center; padding: var(--pico-spacing); background: var(--pico-card-background-color); border-radius: var(--pico-border-radius); box-shadow: var(--pico-card-box-shadow);">
                            <strong style="font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.8;">{{ level_icon }} {{ level_name }}</strong><br>
                            <span style="font-size: 1.8rem; font-weight: bold; line-height: 1.2;">
                                {{ stats.passed }}<small style="font-size: 1rem; opacity: 0.5;">/{{ stats.total }}</small>
                            </span>
                            <div style="font-size: 0.8rem; margin-top: 0.2rem; opacity: 0.7;">{{ stats.percentage }}% pass</div>
                        </div>
                    {% endfor %}
                </div>
                <hr>
                {% endif %}

                {# â”€â”€ Tags summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
                {% if block == "tags" and section.tags_summary %}
                <div class="grid" style="margin-bottom: calc(3 * var(--pico-spacing));">
                    {% for tag_name, stats in section.tags_summary.items() %}
                        <div style="text-align: center; padding: var(--pico-spacing); background: var(--pico-card-background-color); border-radius: var(--pico-border-radius); box-shadow: var(--pico-card-box-shadow);">
                            <strong style="font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.8;">{{ tag_name }}</strong><br>
                            <span style="font-size: 1.8rem; font-weight: bold; line-height: 1.2;">
                                {{ stats.passed }}<small style="font-size: 1rem; opacity: 0.5;">/{{ stats.total }}</small>
                            </span>
                            <div style="font-size: 0.8rem; margin-top: 0.2rem; opacity: 0.7;">{{ stats.percentage }}% pass</div>
                        </div>
                    {% endfor %}
                </div>
                <hr>
                {% endif %}

                {# â”€â”€ Scorecards table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
                {% if block == "scorecards" and section.scorecards %}
                <div class="overflow-auto">
                    <table class="striped">
                        <thead>
                            <tr>
                                <th>Status</th>
                                {% if section.levels_summary %}<th>Level</th>{% endif %}
                                <th>Scorecard</th>
                                <th>Analyzers</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in section.scorecards %}
                            <tr>
                                <td>{{ m.bool_icon(r.passed) }}</td>
                                {% if section.levels_summary %}<td><small>{{ r.level|capitalize }}</small></td>{% endif %}
                                <td>
                                    <strong>{{ r.title|e }}</strong>
                                    {% if r.tags %}
                                    <div style="margin-top: 0.2rem;">
                                        {% for tag in r.tags %}
                                        {{ m.badge(tag) }}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    <div style="font-size: 0.8rem; opacity: 0.7; margin-top: 0.3rem;">{{ r.details|e }}</div>
                                </td>
                                <td>
                                    {% for analyzer in r.analyzers %}
                                    <small>{{ m.badge(analyzer, status="outline") }}</small>
                                    {% endfor %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}

                {# â”€â”€ Analyzers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
                {% if block == "analyzers" and section.display is defined and section.display.analyzers is defined %}
                    {% for analyzer_name in section.display.analyzers %}
                        {% if analyzer_name in report.results %}
                            {% set name = analyzer_name %}
                            {% set data = report.results[analyzer_name] %}
                            <div id="analyzer-{{ name }}">
                                {% if data.error %}
                                    {{ m.error_card(name, data.error) }}
                                {% else %}
                                    {% include [theme ~ "/analyzers/" ~ name ~ ".html", theme ~ "/analyzers/default.html"] %}
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endfor %}
                {% endif %}

            {% endfor %}
        </div>
        {% if not loop.last %}<hr>{% endif %}

        {% endfor %}

        {% if not loop.last %}<hr style="border-width: 2px;">{% endif %}
    {% endfor %}
</article>
