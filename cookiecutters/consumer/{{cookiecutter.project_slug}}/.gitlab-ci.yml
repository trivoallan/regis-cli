spec:
  inputs:
    image_url:
      description: Image URL to analyze (e.g. ghcr.io/username/my-image:latest)
      default: ~
---
stages:
  - request
  - analyze
  - deploy

workflow:
  rules:
    - if: $CI_MERGE_REQUEST_IID
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "web"

# Phase 1: Manual trigger creates a branch and an MR
request_analysis:
  stage: request
  image: alpine:latest
  before_script:
    - apk add --no-cache git
  script:
    - |
      IMAGE_URL="$[[ inputs.image_url ]]"
      # Create a unique branch name
      SAFE_URL=$(echo "$IMAGE_URL" | sed 's/[^a-zA-Z0-9]/_/g')
      BRANCH_NAME="regis/analyze/${SAFE_URL:0:30}-$CI_PIPELINE_IID"

      echo "Creating analysis request for $IMAGE_URL"
      echo "{\"image_url\":\"$IMAGE_URL\"}" > analysis-request.json

      git config --global user.name "GitLab CI"
      git config --global user.email "gitlab-ci@example.com"

      git checkout -b "$BRANCH_NAME"
      git add analysis-request.json
      git commit -m "chore: request analysis for $IMAGE_URL"

      # Push and create MR automatically using push options
      git push "https://oauth2:${GITLAB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" "$BRANCH_NAME" \
        -o merge_request.create \
        -o merge_request.target="$CI_DEFAULT_BRANCH" \
        -o merge_request.title="Analysis Request: $IMAGE_URL" \
        -o merge_request.description="The analysis report will be exposed as an artifact in this Merge Request and committed to the \`reports/\` directory." \
        -o merge_request.remove_source_branch
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web" && "$[[ inputs.image_url ]]" != ""'

# Phase 2: Analyze the image when the MR is opened/updated
analyze_image:
  stage: analyze
  image:
    name: "{{ cookiecutter.regis_cli_image_url }}"
    entrypoint: [""]
  before_script:
    - mkdir -p reports
  script:
    - |
      # Extract image_url from the committed file using python (available in regis-cli image)
      IMAGE_URL=$(python3 -c "import json; print(json.load(open('analysis-request.json'))['image_url'])")
      echo "Analyzing $IMAGE_URL..."

      regis-cli analyze "$IMAGE_URL" \
        --site \
        --playbook "{{ cookiecutter.regis_playbook_url }}" \
        --meta "trigger.user=$GITLAB_USER_LOGIN" \
        --meta "trigger.url=$CI_JOB_URL" \
        --meta "gitlab.mr=$CI_MERGE_REQUEST_IID"

      # Optional: Commit results and post link to MR if GITLAB_TOKEN is provided
      if [ -n "$GITLAB_TOKEN" ]; then
        echo "Pushing report to branch $CI_COMMIT_BRANCH..."
        git config --global user.name "regis-cli bot"
        git config --global user.email "regis-cli@example.com"
        git add reports/
        git commit -m "chore: update analysis report for $IMAGE_URL [skip ci]" || echo "No changes to commit"
        git push "https://oauth2:${GITLAB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" "HEAD:${CI_COMMIT_BRANCH}"
        
        if [ -n "$CI_MERGE_REQUEST_IID" ]; then
          REPORT_INDEX=$(find reports -name index.html | head -n 1)
          if [ -n "$REPORT_INDEX" ]; then
            REPORT_URL="${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/external_file/${REPORT_INDEX}"
            echo "Posting MR comment with link to report..."
            curl --silent --request POST --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
              --header "Content-Type: application/json" \
              --data "{\"body\": \"ðŸš€ **regis-cli Analysis Complete!**\n\nThe full HTML security report is ready: [View Analysis Report]($REPORT_URL)\"}" \
              "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/merge_requests/${CI_MERGE_REQUEST_IID}/notes"
          fi
        fi
      fi
  artifacts:
    expose_as: "Analysis Report"
    paths:
      - reports/
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web" && "$[[ inputs.image_url ]]" != ""'
      when: never
    - if: "$CI_MERGE_REQUEST_IID"
    - if: "$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH"

# Phase 3: Deploy to GitLab Pages (Default branch only)
pages:
  stage: deploy
  image: alpine:latest
  script:
    - echo "Publishing to production pages"
  dependencies:
    - analyze_image
  artifacts:
    paths:
      - reports/
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web" && "$[[ inputs.image_url ]]" != ""'
      when: never
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
