spec:
  inputs:
    image_url:
      description: Image URL to analyze (e.g. ghcr.io/username/my-image:latest)

stages:
  - analyze
  - deploy

analyze:
  stage: analyze
  image:
    name: "{{ cookiecutter.regis_cli_image_url }}"
    entrypoint: [""]
  before_script:
    - mkdir -p public
    - ln -s $(pwd)/playbooks /app/playbooks || true
    - ln -s $(pwd)/public /app/reports || true
  script:
    - |
      regis-cli analyze "$[[ inputs.image_url ]]" \
        --format json \
        --format html \
        --playbook "{{ cookiecutter.regis_playbook_url }}" \
        --output-dir public \
        --meta "trigger.user=$GITLAB_USER_LOGIN" \
        --meta "trigger.url=$CI_PIPELINE_URL" \
        --meta "gitlab.user=$GITLAB_USER_LOGIN" \
        --meta "gitlab.project=$CI_PROJECT_PATH" \
        --meta "gitlab.job_id=$CI_JOB_ID" \
        --meta "gitlab.pipeline_url=$CI_PIPELINE_URL"
    - |
      if [ -n "$GITLAB_TOKEN" ]; then
        echo "  Versioning reports in Git..."
        git config --global user.name "GitLab CI"
        git config --global user.email "gitlab-ci@example.com"
        git add public/
        if git commit -m "chore: update analysis reports [skip ci]"; then
          git push "https://oauth2:${GITLAB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" HEAD:${CI_COMMIT_BRANCH}
        else
          echo "  No changes to commit."
        fi
      else
        echo "  [WARNING] GITLAB_TOKEN not found. Skipping report versioning."
      fi
  artifacts:
    paths:
      - public
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web" && "$[[ inputs.image_url ]]" != ""'
    - if: '$CI_PIPELINE_SOURCE == "trigger" && "$[[ inputs.image_url ]]" != ""'

pages:
  stage: deploy
  image: alpine:latest
  script:
    - echo "Deploying to GitLab Pages"
  artifacts:
    paths:
      - public
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web" && "$[[ inputs.image_url ]]" != ""'
    - if: '$CI_PIPELINE_SOURCE == "trigger" && "$[[ inputs.image_url ]]" != ""'
  needs:
    - analyze
